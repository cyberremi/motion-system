<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <title>Dashboard</title>
</head>
<body>
  <h2>Dashboard Viewer</h2>
  <video id="remoteVideo" autoplay playsinline></video>
  <canvas id="overlay"></canvas>

  <script src="/socket.io/socket.io.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@4.13.0"></script>
  <script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/coco-ssd"></script>

  <script>
    const socket = io();
    const pc = new RTCPeerConnection();

    // Remote video
    pc.ontrack = event => {
      document.getElementById('remoteVideo').srcObject = event.streams[0];
    };

    // Send ICE candidates
    pc.onicecandidate = ({ candidate }) => {
      if (candidate) socket.emit('ice-candidate', candidate);
    };

    // Receive offer from phone
    socket.on('offer', async offer => {
      await pc.setRemoteDescription(new RTCSessionDescription(offer));
      const answer = await pc.createAnswer();
      await pc.setLocalDescription(answer);
      socket.emit('answer', answer);
    });

    // Receive ICE from phone
    socket.on('ice-candidate', async cand => {
      try { await pc.addIceCandidate(new RTCIceCandidate(cand)); } catch(e) {}
    });

    // AI detection overlay
    const video = document.getElementById('remoteVideo');
    const canvas = document.getElementById('overlay');
    const ctx = canvas.getContext('2d');

    async function runDetection() {
      const model = await cocoSsd.load();
      console.log("COCO-SSD model loaded");
      setInterval(async () => {
        if (video.readyState === 4) {
          canvas.width = video.videoWidth;
          canvas.height = video.videoHeight;
          ctx.drawImage(video, 0, 0, canvas.width, canvas.height);

          const preds = await model.detect(video);
          preds.forEach(p => {
            ctx.strokeStyle = "red";
            ctx.lineWidth = 2;
            ctx.strokeRect(...p.bbox);
            ctx.fillStyle = "red";
            ctx.fillText(`${p.class} ${Math.round(p.score*100)}%`, p.bbox[0], p.bbox[1] > 10 ? p.bbox[1]-5 : 10);
          });
        }
      }, 200);
    }
    runDetection();
  </script>
</body>
</html>
