<!doctype html>
<html>
<head><meta charset="utf-8"><title>Dashboard Viewer</title></head>
<body>
  <h2>Dashboard Viewer</h2>
  <video id="remoteVideo" autoplay playsinline></video>
  <canvas id="overlay"></canvas>

  <script src="/socket.io/socket.io.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@4.13.0"></script>
  <script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/coco-ssd"></script>

  <script>
    const socket = io();

    const pcConfig = {
      iceServers: [
        { urls: "stun:stun.l.google.com:19302" },
        {
          urls: [
            "turn:global.xirsys.net:3478?transport=udp",
            "turn:global.xirsys.net:3478?transport=tcp",
            "turns:global.xirsys.net:443?transport=tcp"
          ],
          username: "nextgen",
          credential: "cdfcfc2c-9246-11f0-af15-4662eff0c0a9"
        }
      ]
    };

    const pc = new RTCPeerConnection(pcConfig);
    pc.oniceconnectionstatechange = () => {
      console.log('[PC][viewer] iceConnectionState=', pc.iceConnectionState);
    };
    pc.onicecandidate = (e) => {
      if (e.candidate) {
        console.log('[PC][viewer] sending candidate', e.candidate.candidate);
        socket.emit('ice-candidate', e.candidate);
      }
    };

    pc.ontrack = (event) => {
      console.log('[PC][viewer] got remote track');
      document.getElementById('remoteVideo').srcObject = event.streams[0];
    };

    // When offer arrives from sender, answer it
    socket.on('offer', async (offer) => {
      console.log('[SOCKET][viewer] got offer');
      await pc.setRemoteDescription(new RTCSessionDescription(offer));
      const answer = await pc.createAnswer();
      await pc.setLocalDescription(answer);
      socket.emit('answer', answer);
      console.log('[PC][viewer] sent answer');
    });

    // ICE candidate from sender
    socket.on('ice-candidate', async (cand) => {
      try {
        await pc.addIceCandidate(new RTCIceCandidate(cand));
        console.log('[SOCKET][viewer] added remote candidate');
      } catch (e) {
        console.warn('[viewer] addIceCandidate err', e);
      }
    });

    socket.on('connect', () => console.log('[SOCKET][viewer] connected', socket.id));

    // --- lightweight detection overlay (optional) ---
    (async function runDetection(){
      try {
        const video = document.getElementById('remoteVideo');
        const canvas = document.getElementById('overlay');
        const ctx = canvas.getContext('2d');
        const model = await cocoSsd.load();
        console.log('COCO-SSD loaded');

        setInterval(async () => {
          if (video.readyState !== 4) return;
          canvas.width = video.videoWidth;
          canvas.height = video.videoHeight;
          ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
          const preds = await model.detect(video);
          ctx.strokeStyle = 'red'; ctx.lineWidth = 2; ctx.font = "16px Arial"; ctx.fillStyle = 'red';
          preds.forEach(p => {
            ctx.strokeRect(...p.bbox);
            ctx.fillText(`${p.class} ${Math.round(p.score*100)}%`, p.bbox[0], p.bbox[1] > 16 ? p.bbox[1]-4 : p.bbox[1]+12);
          });
        }, 250);
      } catch (e) {
        console.error('Detection error', e);
      }
    })();
  </script>
</body>
</html>
